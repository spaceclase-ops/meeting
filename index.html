<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SalesFlow - מערכת ניהול פגישות</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Config & Styles -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Heebo', 'sans-serif'] },
            colors: {
              primary: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' },
              secondary: { 50: '#fff1f2', 500: '#f43f5e', 600: '#e11d48' },
              emerald: { 50: '#ecfdf5', 500: '#10b981', 600: '#059669' }
            },
            boxShadow: {
              'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
              'glow': '0 0 15px rgba(139, 92, 246, 0.3)',
            }
          },
        },
      }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hide { display: none !important; }
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #8b5cf6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body class="text-slate-800 antialiased selection:bg-primary-100 selection:text-primary-900">

    <!-- Auth View (Login) -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100">
            <div class="text-center mb-8">
                <div class="bg-primary-50 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary-600">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-black text-slate-800">SalesFlow Login</h1>
                <p class="text-slate-500 text-sm mt-2">הזדהות מאובטחת לצוות המכירות</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1.5 uppercase">אימייל</label>
                    <input type="email" id="email" required class="w-full px-4 py-3 bg-slate-50 border-transparent focus:bg-white focus:ring-2 focus:ring-primary-400 rounded-xl outline-none font-medium text-slate-700 dir-ltr" placeholder="you@company.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1.5 uppercase">סיסמה</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 bg-slate-50 border-transparent focus:bg-white focus:ring-2 focus:ring-primary-400 rounded-xl outline-none font-medium text-slate-700 dir-ltr">
                </div>
                <div id="login-error" class="text-rose-500 text-sm text-center hide"></div>
                <button type="submit" class="w-full py-3.5 rounded-xl text-white bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-700 hover:to-primary-600 shadow-lg shadow-primary-500/30 transition-all font-bold flex justify-center items-center gap-2">
                    <span id="login-btn-text">כניסה למערכת</span>
                    <div id="login-loader" class="loader hide"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- App View (Dashboard) -->
    <div id="app-view" class="hide min-h-screen pb-20">
        
        <!-- Header -->
        <header class="fixed top-0 inset-x-0 z-40 glass border-b border-white/20 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-primary-600 to-primary-800 text-white p-2 rounded-xl shadow-lg shadow-primary-500/30">
                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black text-slate-800 leading-none">SalesFlow</h1>
                        <span id="user-email-display" class="text-xs text-slate-400 font-medium"></span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Date Filter -->
                    <div class="hidden md:flex items-center bg-white rounded-full px-4 py-2 text-sm shadow-soft border border-slate-100">
                        <span class="text-slate-400 pl-3 border-l border-slate-100 text-xs">תאריכים</span>
                        <input type="date" id="date-start" class="bg-transparent border-none outline-none text-slate-700 font-medium px-2 text-xs">
                        <span class="text-slate-300">→</span>
                        <input type="date" id="date-end" class="bg-transparent border-none outline-none text-slate-700 font-medium px-2 text-xs">
                    </div>

                    <button id="logout-btn" class="p-2.5 rounded-full hover:bg-rose-50 text-slate-400 hover:text-rose-500 transition-colors" title="התנתק">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                    
                    <button id="new-meeting-btn" class="bg-slate-900 text-white px-4 py-2.5 rounded-full hover:bg-slate-800 transition-all flex items-center gap-2 font-bold shadow-xl text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">פגישה חדשה</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 pt-28 space-y-8">
            
            <!-- Mobile Date Filter -->
            <div class="md:hidden bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                <span class="text-sm font-bold text-slate-600">טווח:</span>
                <div class="flex gap-2">
                    <input type="date" id="date-start-mobile" class="bg-slate-50 rounded p-1 text-xs">
                    <input type="date" id="date-end-mobile" class="bg-slate-50 rounded p-1 text-xs">
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-soft border border-slate-50 hover:-translate-y-1 transition-transform">
                    <p class="text-slate-500 text-xs font-bold mb-1">סה״כ פגישות</p>
                    <h3 id="stat-total" class="text-3xl font-black text-slate-800">0</h3>
                    <div class="flex justify-end mt-2"><i data-lucide="calendar" class="text-primary-200 w-6 h-6"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-soft border border-slate-50 hover:-translate-y-1 transition-transform">
                    <p class="text-slate-500 text-xs font-bold mb-1">ממתינים</p>
                    <h3 id="stat-pending" class="text-3xl font-black text-slate-800">0</h3>
                    <div class="flex justify-end mt-2"><i data-lucide="clock" class="text-amber-200 w-6 h-6"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-soft border border-slate-50 hover:-translate-y-1 transition-transform">
                    <p class="text-slate-500 text-xs font-bold mb-1">הגיעו</p>
                    <h3 id="stat-attended" class="text-3xl font-black text-slate-800">0</h3>
                    <div class="flex justify-end mt-2"><i data-lucide="users" class="text-emerald-200 w-6 h-6"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-soft border border-slate-50 hover:-translate-y-1 transition-transform">
                    <p class="text-slate-500 text-xs font-bold mb-1">מכירות</p>
                    <h3 id="stat-sold" class="text-3xl font-black text-slate-800">0</h3>
                    <div class="flex justify-end mt-2"><i data-lucide="dollar-sign" class="text-rose-200 w-6 h-6"></i></div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="list" class="w-5 h-5 text-primary-500"></i>
                        רשימת פגישות
                    </h2>
                    <div class="relative">
                        <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="search-input" placeholder="חיפוש..." class="pl-4 pr-10 py-2 bg-white border border-slate-100 rounded-full shadow-soft focus:ring-2 focus:ring-primary-100 outline-none text-sm w-48 sm:w-64">
                    </div>
                </div>

                <div class="bg-white/50 rounded-3xl overflow-hidden min-h-[300px]">
                    <div id="loader-table" class="flex justify-center items-center py-20 hide">
                        <div class="loader"></div>
                    </div>
                    
                    <div id="meetings-container" class="space-y-3 pb-10">
                        <!-- Dynamic Rows will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Form -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 hide opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="flex justify-between items-center p-6 border-b border-slate-100 sticky top-0 bg-white z-10">
                <h2 id="modal-title" class="text-xl font-black text-slate-800">פגישה חדשה</h2>
                <button id="modal-close" class="p-2 rounded-full hover:bg-slate-50 text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="meeting-form" class="p-6 space-y-6">
                <input type="hidden" id="meeting-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 mb-1">שם הלקוח</label>
                        <input type="text" name="clientName" required class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">טלפון</label>
                        <input type="tel" name="phone" required class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">סוג לקוח</label>
                        <select name="clientType" class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                            <option value="מתעניין חדש">מתעניין חדש</option>
                            <option value="לקוח עבר">לקוח עבר</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">תאריך</label>
                        <input type="date" name="date" required class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">שעה</label>
                        <input type="time" name="time" required class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">נציג מטפל</label>
                        <select name="createdBy" id="rep-select" required class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                            <option value="חני">חני</option>
                            <option value="זיו אור">זיו אור</option>
                            <option value="ניר">ניר</option>
                            <option value="מיכל">מיכל</option>
                            <option value="נועה">נועה</option>
                            <option value="ניב">ניב</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">סטטוס</label>
                        <select name="status" class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                            <option value="עדיין לא אישר הגעה">עדיין לא אישר הגעה</option>
                            <option value="אישר הגעה">אישר הגעה</option>
                            <option value="הגיע לפגישה">הגיע לפגישה</option>
                            <option value="לא הגיע לפגישה">לא הגיע לפגישה</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">נמכר מנוי?</label>
                        <select name="subscriptionSold" class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400">
                            <option value="לא">לא</option>
                            <option value="כן">כן</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" name="reminderSent" id="reminderSent" class="w-4 h-4">
                    <label for="reminderSent" class="text-sm text-slate-700">בוצעה שיחת תזכורת?</label>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">הערות</label>
                    <textarea name="notes" rows="3" class="w-full px-4 py-2 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-primary-400"></textarea>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" id="modal-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 text-slate-500 font-bold hover:bg-slate-50">ביטול</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-primary-600 text-white font-bold hover:bg-primary-700 shadow-lg shadow-primary-500/30 flex justify-center gap-2">
                        <span>שמור</span>
                        <div id="save-loader" class="loader border-white border-t-transparent w-5 h-5 hide"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        // --- CONFIGURATION ---
        // Replace these with your actual  Project Credentials
        // If deploying to Vercel with Environment variables, these lines need adjustment, 
        // but for a single HTML file drop, hardcoding (or build injection) is the only way.
const SUPABASE_URL = 'https://qtwnkyeaecdumjkokdbk.supabase.co';
const SUPABASE_KEY = 'sb_publishable_ltaNA7nnVozoSCOcZIjg';

        // --- STATE ---
        let supabase;
        let session = null;
        let meetings = [];
        let dateRange = {
            start: new Date().toISOString().split('T')[0],
            end: new Date().toISOString().split('T')[0]
        };

        // --- DOM ELEMENTS ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginBtnText = document.getElementById('login-btn-text');
        const loginLoader = document.getElementById('login-loader');
        const meetingsContainer = document.getElementById('meetings-container');
        const searchInput = document.getElementById('search-input');
        const dateStart = document.getElementById('date-start');
        const dateEnd = document.getElementById('date-end');
        const dateStartMobile = document.getElementById('date-start-mobile');
        const dateEndMobile = document.getElementById('date-end-mobile');

        // --- INITIALIZATION ---
        async function init() {
            lucide.createIcons();

            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                alert('Please edit index.html and set your SUPABASE_URL and SUPABASE_KEY');
                return;
            }

            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Check Session
            const { data } = await supabase.auth.getSession();
            session = data.session;
            
            updateView();

            supabase.auth.onAuthStateChange((_event, _session) => {
                session = _session;
                updateView();
            });

            // Date Pickers Init
            dateStart.value = dateRange.start;
            dateEnd.value = dateRange.end;
            dateStartMobile.value = dateRange.start;
            dateEndMobile.value = dateRange.end;

            // Event Listeners
            setupEventListeners();
        }

        function updateView() {
            if (session) {
                authView.classList.add('hide');
                appView.classList.remove('hide');
                document.getElementById('user-email-display').textContent = session.user.email;
                fetchMeetings();
            } else {
                authView.classList.remove('hide');
                appView.classList.add('hide');
            }
        }

        // --- AUTH ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            loginBtnText.classList.add('hide');
            loginLoader.classList.remove('hide');
            loginError.classList.add('hide');

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                loginError.textContent = 'שגיאה בהתחברות: ' + error.message;
                loginError.classList.remove('hide');
            }
            
            loginBtnText.classList.remove('hide');
            loginLoader.classList.add('hide');
        }

        async function handleLogout() {
            await supabase.auth.signOut();
        }

        // --- DATA ---
        async function fetchMeetings() {
            document.getElementById('loader-table').classList.remove('hide');
            meetingsContainer.innerHTML = '';
            
            // For simplicity, fetching all and filtering client-side. 
            // In a real huge DB, you'd filter in the query.
            const { data, error } = await supabase
                .from('meetings')
                .select('*')
                .order('date', { ascending: false })
                .order('time', { ascending: true });

            document.getElementById('loader-table').classList.add('hide');

            if (error) {
                console.error('Error fetching meetings:', error);
                return;
            }

            meetings = data;
            renderMeetings();
        }

        async function saveMeeting(e) {
            e.preventDefault();
            const form = e.target;
            const id = document.getElementById('meeting-id').value;
            const saveLoader = document.getElementById('save-loader');
            
            saveLoader.classList.remove('hide');

            const meetingData = {
                client_name: form.clientName.value,
                phone: form.phone.value,
                client_type: form.clientType.value,
                date: form.date.value,
                time: form.time.value,
                created_by: form.createdBy.value,
                status: form.status.value,
                subscription_sold: form.subscriptionSold.value,
                reminder_sent: form.reminderSent.checked,
                notes: form.notes.value,
                user_id: session.user.id
            };

            let error;
            if (id) {
                // Update
                const res = await supabase.from('meetings').update(meetingData).eq('id', id);
                error = res.error;
            } else {
                // Insert
                const res = await supabase.from('meetings').insert([meetingData]);
                error = res.error;
            }

            saveLoader.classList.add('hide');

            if (error) {
                alert('שגיאה בשמירה: ' + error.message);
            } else {
                closeModal();
                fetchMeetings();
            }
        }

        async function deleteMeeting(id) {
            if (!confirm('האם למחוק פגישה זו לצמיתות?')) return;
            
            const { error } = await supabase.from('meetings').delete().eq('id', id);
            
            if (error) {
                alert('שגיאה במחיקה');
            } else {
                fetchMeetings();
            }
        }

        // --- RENDER ---
        function renderMeetings() {
            // Filter logic
            const term = searchInput.value.toLowerCase();
            const filtered = meetings.filter(m => {
                const inDate = m.date >= dateRange.start && m.date <= dateRange.end;
                const inSearch = m.client_name.toLowerCase().includes(term) || m.created_by.includes(term) || (m.phone && m.phone.includes(term));
                return inDate && inSearch;
            });

            // Update Stats
            updateStats(filtered);

            // Render List
            if (filtered.length === 0) {
                meetingsContainer.innerHTML = `
                    <div class="text-center py-10 text-slate-400">
                        <i data-lucide="inbox" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                        <p>לא נמצאו פגישות</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            meetingsContainer.innerHTML = filtered.map(m => `
                <div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-50 flex flex-col md:flex-row md:items-center justify-between gap-4 hover:shadow-md transition-shadow group">
                    
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col items-center min-w-[60px] border-l border-slate-100 pl-4">
                            <span class="font-bold text-lg text-slate-800">${m.time.slice(0,5)}</span>
                            <span class="text-xs text-slate-400">${formatDate(m.date)}</span>
                        </div>
                        
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">${m.client_name}</h3>
                            <div class="flex items-center gap-2 text-sm text-slate-500 mt-1">
                                <span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${m.phone || '-'}</span>
                                <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                <span>${m.client_type}</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center gap-3 md:gap-6 mt-2 md:mt-0">
                         <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-600 border border-white shadow-sm" title="נציג">
                                ${m.created_by.charAt(0)}
                            </div>
                            <span class="text-sm font-medium text-slate-600 hidden md:block">${m.created_by}</span>
                        </div>

                        <span class="px-3 py-1 rounded-full text-xs font-bold border ${getStatusColor(m.status)}">
                            ${m.status}
                        </span>

                        ${m.subscription_sold === 'כן' ? 
                            '<span class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded text-xs font-bold">נמכר!</span>' : ''}

                        <div class="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openEditModal('${m.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="deleteMeeting('${m.id}')" class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function updateStats(filtered) {
            const total = filtered.length;
            const pending = filtered.filter(m => m.status === 'עדיין לא אישר הגעה').length;
            const attended = filtered.filter(m => m.status === 'הגיע לפגישה').length;
            const sold = filtered.filter(m => m.subscription_sold === 'כן').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-attended').textContent = attended;
            document.getElementById('stat-sold').textContent = sold;
        }

        // --- HELPERS ---
        function getStatusColor(status) {
            switch (status) {
                case 'אישר הגעה': return 'bg-blue-50 text-blue-700 border-blue-100';
                case 'הגיע לפגישה': return 'bg-emerald-50 text-emerald-700 border-emerald-100';
                case 'לא הגיע לפגישה': return 'bg-rose-50 text-rose-700 border-rose-100';
                default: return 'bg-amber-50 text-amber-700 border-amber-100';
            }
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth()+1}`;
        }

        // --- MODAL & UI HANDLERS ---
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');
        const meetingForm = document.getElementById('meeting-form');

        function openModal() {
            modalOverlay.classList.remove('hide');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            modalOverlay.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modalOverlay.classList.add('hide');
                meetingForm.reset();
                document.getElementById('meeting-id').value = '';
                document.getElementById('modal-title').textContent = 'פגישה חדשה';
            }, 300);
        }

        // Needed to expose to global scope for HTML onclick
        window.openEditModal = (id) => {
            const m = meetings.find(x => x.id === id);
            if (!m) return;
            
            document.getElementById('meeting-id').value = m.id;
            document.getElementById('modal-title').textContent = 'עריכת פגישה';
            
            const form = meetingForm;
            form.clientName.value = m.client_name;
            form.phone.value = m.phone;
            form.clientType.value = m.client_type;
            form.date.value = m.date;
            form.time.value = m.time;
            form.createdBy.value = m.created_by;
            form.status.value = m.status;
            form.subscriptionSold.value = m.subscription_sold || 'לא';
            form.reminderSent.checked = m.reminder_sent;
            form.notes.value = m.notes || '';

            openModal();
        };

        window.deleteMeeting = deleteMeeting; // expose

        function setupEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('new-meeting-btn').addEventListener('click', openModal);
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('modal-cancel').addEventListener('click', closeModal);
            meetingForm.addEventListener('submit', saveMeeting);

            // Filtering
            const handleFilterChange = () => {
                dateRange.start = dateStart.value || dateStartMobile.value;
                dateRange.end = dateEnd.value || dateEndMobile.value;
                
                // Sync inputs
                dateStart.value = dateRange.start;
                dateStartMobile.value = dateRange.start;
                dateEnd.value = dateRange.end;
                dateEndMobile.value = dateRange.end;

                renderMeetings();
            };

            searchInput.addEventListener('input', renderMeetings);
            dateStart.addEventListener('change', handleFilterChange);
            dateEnd.addEventListener('change', handleFilterChange);
            dateStartMobile.addEventListener('change', handleFilterChange);
            dateEndMobile.addEventListener('change', handleFilterChange);
        }

        // Start
        init();

    </script>
</body>

</html>


